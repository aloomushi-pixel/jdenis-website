// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// USERS & AUTHENTICATION
// ========================================

enum UserRole {
  ADMIN
  TRANSPORTISTA
  ALMACEN_MATERIA_PRIMA
  ALMACEN_PRODUCTO_FINAL
  FABRICA
  EJECUTIVO
  CLIENTE
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  fullName      String   @map("full_name")
  role          UserRole
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  purchaseOrders          PurchaseOrder[]
  salesOrders             SalesOrder[]
  productionBatches       ProductionBatch[]
  receivingLogs           ReceivingLog[]
  dispatchLogs            DispatchLog[]
  deliveryAssignments     DeliveryAssignment[]
  protocolExecutions      ProtocolExecution[]
  stockUpdates            Stock[]
  handoffAsWarehouse      HandoffRecord[]       @relation("WarehouseStaff")
  handoffAsTransporter    HandoffRecord[]       @relation("Transporter")
  
  // New relations
  quotationsCreated       Quotation[]           @relation("CreatedQuotations")
  ordersCreated           Order[]               @relation("CreatedOrders")
  ordersAssigned          Order[]               @relation("AssignedOrders")
  events                  EventLog[]            @relation("UserEvents")
  wasteRecords            WasteTolerance[]      @relation("RecordedWaste")
  photosUploaded          Photo[]               @relation("UploadedPhotos")
  packagingProcessed      PackagingRecord[]     @relation("ProcessedPackaging")

  @@map("users")
}

// ========================================
// PRODUCTS & INVENTORY
// ========================================

enum ProductType {
  RAW_MATERIAL
  FINISHED_PRODUCT
}

model Product {
  id          String      @id @default(uuid())
  sku         String      @unique
  name        String
  description String?
  type        ProductType
  unit        String      // kg, liters, pieces, etc.
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  stock                    Stock[]
  purchaseOrderItems       PurchaseOrderItem[]
  salesOrderItems          SalesOrderItem[]
  materialConsumptions     MaterialConsumption[]
  productionOutputs        ProductionOutput[]
  receivingLogs            ReceivingLog[]
  dispatchLogs             DispatchLog[]

  @@map("products")
}

enum LocationType {
  OFFICE
  FACTORY
  WAREHOUSE
}

model InventoryLocation {
  id            String       @id @default(uuid())
  name          String
  locationType  LocationType @map("location_type")
  capacity      Int?
  createdAt     DateTime     @default(now()) @map("created_at")

  // Relations
  stock         Stock[]
  storageRacks  StorageRack[]

  @@map("inventory_locations")
}

model Stock {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  locationId  String   @map("location_id")
  quantity    Float
  lastUpdated DateTime @default(now()) @map("last_updated")
  updatedBy   String?  @map("updated_by")

  // Relations
  product     Product           @relation(fields: [productId], references: [id])
  location    InventoryLocation @relation(fields: [locationId], references: [id])
  updatedByUser User?           @relation(fields: [updatedBy], references: [id])

  @@unique([productId, locationId])
  @@map("stock")
}

// ========================================
// ADMINISTRATION (OFFICE)
// ========================================

model Supplier {
  id          String   @id @default(uuid())
  name        String
  contactName String?  @map("contact_name")
  email       String?
  phone       String?
  address     String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

model Customer {
  id          String   @id @default(uuid())
  name        String
  contactName String?  @map("contact_name")
  email       String?
  phone       String?
  address     String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  salesOrders SalesOrder[]
  quotations  Quotation[]
  orders      Order[]

  @@map("customers")
}

enum PurchaseOrderStatus {
  PENDING
  APPROVED
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id           String              @id @default(uuid())
  orderNumber  String              @unique @map("order_number")
  supplierId   String              @map("supplier_id")
  totalAmount  Float               @map("total_amount")
  status       PurchaseOrderStatus
  notes        String?
  createdBy    String              @map("created_by")
  createdAt    DateTime            @default(now()) @map("created_at")
  approvedAt   DateTime?           @map("approved_at")

  // Relations
  supplier     Supplier            @relation(fields: [supplierId], references: [id])
  createdByUser User               @relation(fields: [createdBy], references: [id])
  items        PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String        @map("purchase_order_id")
  productId       String        @map("product_id")
  quantity        Float
  unitPrice       Float         @map("unit_price")

  // Relations
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])

  @@map("purchase_order_items")
}

enum SalesOrderStatus {
  PENDING
  PROCESSING
  DISPATCHED
  DELIVERED
  CANCELLED
}

model SalesOrder {
  id            String           @id @default(uuid())
  orderNumber   String           @unique @map("order_number")
  customerId    String           @map("customer_id")
  totalAmount   Float            @map("total_amount")
  status        SalesOrderStatus
  notes         String?
  createdBy     String           @map("created_by")
  createdAt     DateTime         @default(now()) @map("created_at")
  dispatchedAt  DateTime?        @map("dispatched_at")
  deliveredAt   DateTime?        @map("delivered_at")

  // Relations
  customer      Customer         @relation(fields: [customerId], references: [id])
  createdByUser User             @relation(fields: [createdBy], references: [id])
  items         SalesOrderItem[]
  dispatchLogs  DispatchLog[]
  deliveryAssignments DeliveryAssignment[]

  @@map("sales_orders")
}

model SalesOrderItem {
  id           String     @id @default(uuid())
  salesOrderId String     @map("sales_order_id")
  productId    String     @map("product_id")
  quantity     Float
  unitPrice    Float      @map("unit_price")

  // Relations
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id])

  @@map("sales_order_items")
}

// ========================================
// FACTORY OPERATIONS
// ========================================

enum ProductionBatchStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model ProductionBatch {
  id           String                @id @default(uuid())
  batchNumber  String                @unique @map("batch_number")
  startDate    DateTime              @default(now()) @map("start_date")
  endDate      DateTime?             @map("end_date")
  status       ProductionBatchStatus
  notes        String?
  createdBy    String                @map("created_by")

  // Relations
  createdByUser        User                  @relation(fields: [createdBy], references: [id])
  materialConsumptions MaterialConsumption[]
  productionOutputs    ProductionOutput[]
  wasteRecords         WasteTolerance[]

  @@map("production_batches")
}

model MaterialConsumption {
  id           String          @id @default(uuid())
  batchId      String          @map("batch_id")
  productId    String          @map("product_id")
  quantityUsed Float           @map("quantity_used")
  recordedAt   DateTime        @default(now()) @map("recorded_at")

  // Relations
  batch        ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  product      Product         @relation(fields: [productId], references: [id])

  @@map("material_consumptions")
}

model ProductionOutput {
  id                String          @id @default(uuid())
  batchId           String          @map("batch_id")
  productId         String          @map("product_id")
  quantityProduced  Float           @map("quantity_produced")
  recordedAt        DateTime        @default(now()) @map("recorded_at")
  verifiedBy        String?         @map("verified_by")

  // Relations
  batch             ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  product           Product         @relation(fields: [productId], references: [id])

  @@map("production_outputs")
}

// ========================================
// WAREHOUSE OPERATIONS
// ========================================

model StorageRack {
  id                  String            @id @default(uuid())
  rackCode            String            @unique @map("rack_code")
  locationId          String            @map("location_id")
  capacity            Float
  currentUtilization  Float             @default(0) @map("current_utilization")
  createdAt           DateTime          @default(now()) @map("created_at")

  // Relations
  location            InventoryLocation @relation(fields: [locationId], references: [id])

  @@map("storage_racks")
}

enum ReceivingSource {
  FACTORY
  SUPPLIER
}

model ReceivingLog {
  id         String          @id @default(uuid())
  source     ReceivingSource
  productId  String          @map("product_id")
  quantity   Float
  receivedAt DateTime        @default(now()) @map("received_at")
  verifiedBy String          @map("verified_by")
  notes      String?

  // Relations
  product    Product         @relation(fields: [productId], references: [id])
  verifiedByUser User        @relation(fields: [verifiedBy], references: [id])

  @@map("receiving_logs")
}

model DispatchLog {
  id            String   @id @default(uuid())
  salesOrderId  String   @map("sales_order_id")
  productId     String   @map("product_id")
  quantity      Float
  dispatchedAt  DateTime @default(now()) @map("dispatched_at")
  preparedBy    String   @map("prepared_by")
  transporterId String?  @map("transporter_id")
  notes         String?

  // Relations
  salesOrder    SalesOrder     @relation(fields: [salesOrderId], references: [id])
  product       Product        @relation(fields: [productId], references: [id])
  preparedByUser User          @relation(fields: [preparedBy], references: [id])
  handoffRecords HandoffRecord[]

  @@map("dispatch_logs")
}

model HandoffRecord {
  id               String       @id @default(uuid())
  dispatchLogId    String       @map("dispatch_log_id")
  warehouseStaffId String       @map("warehouse_staff_id")
  transporterId    String       @map("transporter_id")
  handoffTime      DateTime     @default(now()) @map("handoff_time")
  signatureData    String?      @map("signature_data") // Base64 encoded signature
  notes            String?

  // Relations
  dispatchLog      DispatchLog  @relation(fields: [dispatchLogId], references: [id])
  warehouseStaff   User         @relation("WarehouseStaff", fields: [warehouseStaffId], references: [id])
  transporter      User         @relation("Transporter", fields: [transporterId], references: [id])

  @@map("handoff_records")
}

// ========================================
// TRANSPORT & ASSETS
// ========================================

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  OUT_OF_SERVICE
}

model Vehicle {
  id              String        @id @default(uuid())
  vehicleNumber   String        @unique @map("vehicle_number")
  vehicleType     String        @map("vehicle_type")
  capacity        Float
  status          VehicleStatus
  lastMaintenance DateTime?     @map("last_maintenance")
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  deliveryAssignments DeliveryAssignment[]

  @@map("vehicles")
}

enum DeliveryStatus {
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model DeliveryAssignment {
  id            String         @id @default(uuid())
  salesOrderId  String         @map("sales_order_id")
  vehicleId     String         @map("vehicle_id")
  transporterId String         @map("transporter_id")
  status        DeliveryStatus
  assignedAt    DateTime       @default(now()) @map("assigned_at")
  completedAt   DateTime?      @map("completed_at")
  notes         String?

  // Relations
  salesOrder    SalesOrder     @relation(fields: [salesOrderId], references: [id])
  vehicle       Vehicle        @relation(fields: [vehicleId], references: [id])
  transporter   User           @relation(fields: [transporterId], references: [id])

  @@map("delivery_assignments")
}

// ========================================
// PROTOCOLS & CHECKLISTS
// ========================================

enum ProtocolType {
  FACTORY_MATERIAL_ENTRY
  FACTORY_PRODUCTION_OUTPUT
  WAREHOUSE_RECEIVING
  WAREHOUSE_DISPATCH
}

model ProtocolTemplate {
  id          String       @id @default(uuid())
  name        String
  type        ProtocolType
  description String?
  steps       Json         // Array of step objects: [{ order: 1, description: "...", required: true }]
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")

  // Relations
  executions  ProtocolExecution[]

  @@map("protocol_templates")
}

enum ProtocolExecutionStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model ProtocolExecution {
  id         String                  @id @default(uuid())
  templateId String                  @map("template_id")
  executedBy String                  @map("executed_by")
  startedAt  DateTime                @default(now()) @map("started_at")
  completedAt DateTime?              @map("completed_at")
  status     ProtocolExecutionStatus
  stepsData  Json                    @map("steps_data") // Array of completed steps with timestamps and notes

  // Relations
  template   ProtocolTemplate        @relation(fields: [templateId], references: [id])
  executor   User                    @relation(fields: [executedBy], references: [id])

  @@map("protocol_executions")
}

// ========================================
// RESOURCE MANAGEMENT
// ========================================

enum ResourceCategory {
  MATERIA_PRIMA
  EMBALAJE
  PRODUCTO_FINAL
  VEHICULOS
}

enum ResourceFormat {
  LITROS
  KILOGRAMOS
  PIEZA
}

model Resource {
  id                      String           @id @default(cuid())
  category                ResourceCategory
  title                   String
  format                  ResourceFormat
  quantity                Float            @default(0)
  brand                   String?
  imageUrl                String?          @map("image_url")
  satCode                 String?          @map("sat_code") // For finished products
  rawMaterialComposition  Json?            @map("raw_material_composition") // For finished products
  createdAt               DateTime         @default(now()) @map("created_at")
  updatedAt               DateTime         @updatedAt @map("updated_at")

  // Relations
  quotationItems          QuotationItem[]
  orderItems              OrderItem[]
  eventLogs               EventLog[]

  @@map("resources")
}

// ========================================
// QUOTATIONS & ORDERS (ENHANCED)
// ========================================

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  CONVERTED
}

model Quotation {
  id            String          @id @default(uuid())
  quotationNumber String        @unique @map("quotation_number")
  customerId    String          @map("customer_id")
  totalAmount   Float           @map("total_amount")
  status        QuotationStatus
  validUntil    DateTime?       @map("valid_until")
  notes         String?
  createdBy     String          @map("created_by")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  customer      Customer        @relation(fields: [customerId], references: [id])
  createdByUser User            @relation("CreatedQuotations", fields: [createdBy], references: [id])
  items         QuotationItem[]
  convertedOrder Order?

  @@map("quotations")
}

model QuotationItem {
  id           String     @id @default(uuid())
  quotationId  String     @map("quotation_id")
  resourceId   String     @map("resource_id")
  quantity     Float
  unitPrice    Float      @map("unit_price")

  // Relations
  quotation    Quotation  @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  resource     Resource   @relation(fields: [resourceId], references: [id])

  @@map("quotation_items")
}

enum OrderStatus {
  COTIZADO
  PENDIENTE
  EN_PRODUCCION
  EN_EMBALAJE
  EN_TRANSITO
  ENTREGADO
  CANCELADO
}

model Order {
  id              String       @id @default(uuid())
  orderNumber     String       @unique @map("order_number")
  customerId      String       @map("customer_id")
  quotationId     String?      @unique @map("quotation_id")
  totalAmount     Float        @map("total_amount")
  currentStatus   OrderStatus  @map("current_status")
  deliveryDate    DateTime?    @map("delivery_date")
  assignedTo      String?      @map("assigned_to")
  blockchainHistory Json       @default("[]") @map("blockchain_history") // Array of status changes
  createdBy       String       @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  customer        Customer     @relation(fields: [customerId], references: [id])
  quotation       Quotation?   @relation(fields: [quotationId], references: [id])
  createdByUser   User         @relation("CreatedOrders", fields: [createdBy], references: [id])
  assignedToUser  User?        @relation("AssignedOrders", fields: [assignedTo], references: [id])
  items           OrderItem[]
  packagingRecords PackagingRecord[]

  @@map("orders")
}

model OrderItem {
  id         String   @id @default(uuid())
  orderId    String   @map("order_id")
  resourceId String   @map("resource_id")
  quantity   Float
  unitPrice  Float    @map("unit_price")

  // Relations
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  resource   Resource @relation(fields: [resourceId], references: [id])

  @@map("order_items")
}

// ========================================
// EVENT LOGGING
// ========================================

enum EventType {
  COMPRA
  VENTA
  INGRESO
  EGRESO
  PRODUCCION
  EMBALAJE
  TRANSPORTE
}

model EventLog {
  id          String    @id @default(uuid())
  eventType   EventType @map("event_type")
  userId      String    @map("user_id")
  resourceId  String?   @map("resource_id")
  quantity    Float?
  details     Json?     // Additional event-specific data
  timestamp   DateTime  @default(now())

  // Relations
  user        User      @relation("UserEvents", fields: [userId], references: [id])
  resource    Resource? @relation(fields: [resourceId], references: [id])

  @@map("event_logs")
}

// ========================================
// WASTE & TOLERANCE
// ========================================

model WasteTolerance {
  id               String   @id @default(uuid())
  batchId          String   @map("batch_id")
  expectedQuantity Float    @map("expected_quantity")
  actualQuantity   Float    @map("actual_quantity")
  wastePercentage  Float    @map("waste_percentage")
  notes            String?
  recordedAt       DateTime @default(now()) @map("recorded_at")
  recordedBy       String   @map("recorded_by")

  // Relations
  batch            ProductionBatch @relation(fields: [batchId], references: [id])
  recordedByUser   User            @relation("RecordedWaste", fields: [recordedBy], references: [id])

  @@map("waste_tolerance")
}

// ========================================
// PHOTOS & DOCUMENTATION
// ========================================

enum PhotoEntityType {
  ORDER
  PLIST
  WEIGHT
  PACKAGING
  DELIVERY
}

model Photo {
  id          String           @id @default(uuid())
  entityType  PhotoEntityType  @map("entity_type")
  entityId    String           @map("entity_id")
  url         String
  uploadedBy  String           @map("uploaded_by")
  uploadedAt  DateTime         @default(now()) @map("uploaded_at")

  // Relations
  uploader    User             @relation("UploadedPhotos", fields: [uploadedBy], references: [id])

  @@map("photos")
}

// ========================================
// PACKAGING (EMBALAJE)
// ========================================

model PackagingRecord {
  id            String   @id @default(uuid())
  orderId       String   @map("order_id")
  quantityIn    Float    @map("quantity_in")
  quantityOut   Float    @map("quantity_out")
  packagingType String   @map("packaging_type")
  photoIds      Json     @default("[]") @map("photo_ids") // Array of photo IDs
  processedBy   String   @map("processed_by")
  processedAt   DateTime @default(now()) @map("processed_at")

  // Relations
  order         Order    @relation(fields: [orderId], references: [id])
  processor     User     @relation("ProcessedPackaging", fields: [processedBy], references: [id])

  @@map("packaging_records")
}

